---
import Layout from '../layouts/Layout.astro';
import { container } from '../config/container';

// No prerender esta página porque usa base de datos
export const prerender = false;

interface Coin {
  id: string;
  name: string;
  description?: string;
  date_added: string;
  [key: string]: any;
}

// Paginación: cargar solo los primeros 50 elementos
const page = 1;
const limit = 50;
const coinService = container.coinService;
const { coins: fetchedCoins, total: totalCoins } = await coinService.getAllCoins(limit, 0);
const coins: Coin[] = (fetchedCoins || []) as any;
const totalPages = Math.ceil(totalCoins / limit);
---

<Layout>
	<div>
		<h1 class="text-3xl md:text-4xl font-bold mb-2 text-gray-900">Mi Colección</h1>
		<p class="text-gray-700 mb-8">Total: {totalCoins} {totalCoins === 1 ? 'moneda' : 'monedas'}</p>
		{coins.length === 0 && (
			<div class="text-center py-12 bg-white rounded-lg border border-gray-200">
				<p class="text-gray-700 text-lg mb-4">Aún no tienes monedas</p>
				<a href="/upload" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition inline-block active:scale-95">Capturar primeras monedas</a>
			</div>
		)}
		<div id="coinsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-8">
			{coins.map((coin) => (
				<a href={`/coin-detail/${coin.id}`} class="group cursor-pointer block">
					<div class="bg-white rounded-lg shadow hover:shadow-xl transition-all overflow-hidden relative border border-gray-200 hover:border-blue-300">
						<img src={`/api/coin-image/${coin.id}`} alt={coin.name} class="w-full aspect-square object-cover group-hover:brightness-75 transition" loading="lazy">
						<div class="p-3 bg-gradient-to-t from-gray-900 via-transparent to-transparent absolute inset-0 opacity-0 group-hover:opacity-100 transition flex flex-col justify-end">
							<h3 class="font-bold text-white text-xs sm:text-sm truncate">{coin.name}</h3>
							<p class="text-xs text-gray-200 mt-1 flex items-center gap-1">
								<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"></path></svg>
								Ver detalles
							</p>
						</div>
						<div class="p-3">
							<h3 class="font-semibold text-xs sm:text-sm text-gray-900 truncate">{coin.name}</h3>
							<p class="text-xs text-gray-600 mt-1">{new Date(coin.date_added).toLocaleDateString()}</p>
						</div>
					</div>
				</a>
			))}
		</div>

		{/* Botón para cargar más - Solo si hay más monedas */}
		{totalCoins > 50 && (
			<div class="mb-8 text-center">
				<button id="loadMoreBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition active:scale-95">
					Cargar más ({coins.length}/{totalCoins})
				</button>
				<div id="loadingIndicator" class="hidden mt-4">
					<p class="text-gray-600">Cargando...</p>
				</div>
			</div>
		)}
	</div>
</Layout>

<script define:vars={{totalCoins}}>
	let currentPage = 1;
	const TOTAL_COINS = totalCoins;
	const LIMIT = 50;

	const loadMoreBtn = document.getElementById('loadMoreBtn');
	const loadingIndicator = document.getElementById('loadingIndicator');
	const coinsGrid = document.getElementById('coinsGrid');

	if (loadMoreBtn) {
		loadMoreBtn.addEventListener('click', loadMore);
	}

	async function loadMore() {
		if (!loadMoreBtn || !loadingIndicator || !coinsGrid) return;
		currentPage++;
		loadMoreBtn.disabled = true;
		loadingIndicator?.classList.remove('hidden');

		try {
			const response = await fetch(`/api/coins-paginated?page=${currentPage}&limit=${LIMIT}`);
			const data = await response.json();
			
			// Agregar nuevas monedas al grid
			const fragment = document.createDocumentFragment();
			data.coins.forEach((coin) => {
				const link = document.createElement('a');
				link.href = `/coin-detail/${coin.id}`;
				link.className = 'group cursor-pointer block';
				link.innerHTML = `
					<div class="bg-white rounded-lg shadow hover:shadow-xl transition-all overflow-hidden relative border border-gray-200 hover:border-blue-300">
						<img src="/api/coin-image/${coin.id}" alt="${coin.name}" class="w-full aspect-square object-cover group-hover:brightness-75 transition" loading="lazy">
						<div class="p-3 bg-gradient-to-t from-gray-900 via-transparent to-transparent absolute inset-0 opacity-0 group-hover:opacity-100 transition flex flex-col justify-end">
							<h3 class="font-bold text-white text-xs sm:text-sm truncate">${coin.name}</h3>
							<p class="text-xs text-gray-200 mt-1 flex items-center gap-1">
								<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z"></path></svg>
								Ver detalles
							</p>
						</div>
						<div class="p-3">
							<h3 class="font-semibold text-xs sm:text-sm text-gray-900 truncate">${coin.name}</h3>
							<p class="text-xs text-gray-600 mt-1">${new Date(coin.date_added).toLocaleDateString()}</p>
						</div>
					</div>
				`;
				fragment.appendChild(link);
			});
			coinsGrid?.appendChild(fragment);

			// Actualizar botón
			const loaded = currentPage * LIMIT;
			if (loadMoreBtn) {
				loadMoreBtn.textContent = `Cargar más (${loaded}/${TOTAL_COINS})`;
				
				// Ocultar botón si no hay más monedas
				if (!data.hasMore) {
					loadMoreBtn.style.display = 'none';
				}
			}
		} catch (error) {
			console.error('Error cargando más monedas:', error);
		} finally {
			if (loadMoreBtn) loadMoreBtn.disabled = false;
			loadingIndicator?.classList.add('hidden');
		}
	}
</script>