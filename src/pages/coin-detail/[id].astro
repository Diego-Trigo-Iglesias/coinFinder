---
import Layout from '../../layouts/Layout.astro';
import { getCoinById, getCoinImage } from '../../lib/db';

export const prerender = false;

const { id } = Astro.params;

if (!id) {
  return new Response(JSON.stringify({ error: 'ID requerido' }), { status: 400 });
}

interface Coin {
  id: string;
  name: string;
  description?: string;
  year?: string;
  coin_type?: string;
  country?: string;
  denomination?: string;
  mint?: string;
  rarity?: number;
  approximate_value?: string;
  date_added: string;
  [key: string]: any;
}

const coinRow = getCoinById.get(id);
const coin = coinRow as unknown as Coin;

if (!coin) {
  return new Response(JSON.stringify({ error: 'Moneda no encontrada' }), { status: 404 });
}

const imageRecordRow = getCoinImage.get(id);
const imageRecord = imageRecordRow as unknown as { image_data?: any };
const imageData = imageRecord?.image_data ? Buffer.from(imageRecord.image_data).toString('base64') : null;
const imageUrl = imageData ? `data:image/jpeg;base64,${imageData}` : null;
---

<Layout>
	<div class="max-w-4xl mx-auto">
		<!-- Header con botones -->
		<div class="flex items-center justify-between mb-8">
			<a href="/collection" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold">
				<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
				</svg>
				Volver a colección
			</a>
			<div class="flex gap-2">
				<button id="editBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center gap-2 transition">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
					</svg>
					Editar
				</button>
				<button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center gap-2 transition">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
					</svg>
					Eliminar
				</button>
			</div>
		</div>

		<!-- Contenido principal -->
		<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
			<!-- Imagen de la moneda -->
			<div class="flex flex-col items-center">
				{imageUrl ? (
					<div class="w-full aspect-square rounded-lg overflow-hidden shadow-lg bg-gray-100 mb-4 flex items-center justify-center">
						<img src={imageUrl} alt={coin.name} class="w-full h-full object-cover">
					</div>
				) : (
					<div class="w-full aspect-square rounded-lg bg-gray-200 flex items-center justify-center mb-4">
						<span class="text-gray-400">Sin imagen</span>
					</div>
				)}
				<p class="text-sm text-gray-500">Añadida: {new Date(coin.date_added).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
			</div>

			<!-- Información de la moneda -->
			<div class="space-y-6">
				<!-- Nombre y descripción -->
				<div>
					<h1 class="text-4xl font-bold text-gray-900 mb-2">{coin.name}</h1>
					{coin.description && (
						<p class="text-lg text-gray-600">{coin.description}</p>
					)}
				</div>

				<!-- Detalles principales -->
				<div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-100">
					<h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
						<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
						Detalles de la moneda
					</h2>
					
					<div class="grid grid-cols-2 gap-4">
						{coin.coin_type && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Tipo</p>
								<p class="text-lg text-gray-900 font-semibold">{coin.coin_type}</p>
							</div>
						)}
						{coin.year && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Año</p>
								<p class="text-lg text-gray-900 font-semibold">{coin.year}</p>
							</div>
						)}
						{coin.country && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">País</p>
								<p class="text-lg text-gray-900 font-semibold">{coin.country}</p>
							</div>
						)}
						{coin.denomination && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Denominación</p>
								<p class="text-lg text-gray-900 font-semibold">{coin.denomination}</p>
							</div>
						)}
						{coin.mint && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Casa de Moneda</p>
								<p class="text-lg text-gray-900 font-semibold">{coin.mint}</p>
							</div>
						)}
						{coin.rarity && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Rareza</p>
								<div class="flex items-center gap-1 mt-1">
									{[1, 2, 3, 4, 5].map((star) => (
										<svg class={`w-5 h-5 ${star <= (coin.rarity || 0) ? 'text-yellow-400' : 'text-gray-300'}`} fill="currentColor" viewBox="0 0 20 20">
											<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
										</svg>
									))}
								</div>
							</div>
						)}
						{coin.approximate_value && (
							<div>
								<p class="text-sm text-gray-600 font-semibold">Valor Aproximado</p>
								<p class="text-lg text-green-600 font-semibold">{coin.approximate_value}</p>
							</div>
						)}
					</div>
				</div>
			</div>
		</div>

		<!-- Modal de edición - Inicialmente oculto -->
		<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-end sm:items-center justify-center z-50 p-4">
			<div class="bg-white p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl w-full sm:w-2xl max-h-[90vh] overflow-y-auto">
				<div class="flex items-center justify-between mb-6">
					<h2 class="text-2xl font-bold text-gray-900">Editar Moneda</h2>
					<button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>

				<form id="editForm" class="space-y-4">
					<div>
						<label class="block text-sm font-semibold text-gray-900 mb-1">Nombre</label>
						<input type="text" id="editName" name="name" value={coin.name} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
					</div>

					<div>
						<label class="block text-sm font-semibold text-gray-900 mb-1">Descripción</label>
						<textarea id="editDescription" name="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none">{coin.description}</textarea>
					</div>

					<div class="grid grid-cols-2 gap-4">
						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">Año</label>
							<input type="text" id="editYear" name="year" value={coin.year || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>

						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">Tipo</label>
							<input type="text" id="editCoinType" name="coin_type" value={coin.coin_type || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>

						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">Acuñación</label>
							<input type="text" id="editMint" name="mint" value={coin.mint || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>

						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">País</label>
							<input type="text" id="editCountry" name="country" value={coin.country || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>

						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">Denominación</label>
							<input type="text" id="editDenomination" name="denomination" value={coin.denomination || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>

						<div>
							<label class="block text-sm font-semibold text-gray-900 mb-1">Rareza (1-5)</label>
							<input type="number" id="editRarity" name="rarity" min="1" max="5" value={coin.rarity || 1} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
						</div>
					</div>

					<div>
						<label class="block text-sm font-semibold text-gray-900 mb-1">Valor Aproximado</label>
						<input type="text" id="editValue" name="approximate_value" value={coin.approximate_value || ''} class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
					</div>

					<div class="flex gap-3 pt-4">
						<button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
							Guardar Cambios
						</button>
						<button type="button" id="cancelEditBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 rounded-lg transition">
							Cancelar
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</Layout>

<script define:vars={{coinId: id}}>
	const editBtn = document.getElementById('editBtn');
	const deleteBtn = document.getElementById('deleteBtn');
	const editModal = document.getElementById('editModal');
	const closeModalBtn = document.getElementById('closeModalBtn');
	const cancelEditBtn = document.getElementById('cancelEditBtn');
	const editForm = document.getElementById('editForm');

	editBtn?.addEventListener('click', () => {
		editModal?.classList.remove('hidden');
	});

	const closeModal = () => {
		editModal?.classList.add('hidden');
	};

	closeModalBtn?.addEventListener('click', closeModal);
	cancelEditBtn?.addEventListener('click', closeModal);

	editForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		const formData = new FormData(e.target);
		
		const data = {
			name: formData.get('name'),
			description: formData.get('description'),
			year: formData.get('year'),
			coin_type: formData.get('coin_type'),
			mint: formData.get('mint'),
			approximate_value: formData.get('approximate_value'),
			rarity: parseInt(String(formData.get('rarity'))) || 1,
			country: formData.get('country'),
			denomination: formData.get('denomination')
		};

		try {
			const response = await fetch(`/api/coins/${coinId}`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			});

			if (response.ok) {
				closeModal();
				location.reload();
			} else {
				alert('Error al guardar cambios');
			}
		} catch (error) {
			console.error('Error:', error);
			alert('Error al guardar cambios');
		}
	});

	deleteBtn?.addEventListener('click', async () => {
		if (confirm('¿Estás seguro de que deseas eliminar esta moneda?')) {
			try {
				const response = await fetch(`/api/coins/${coinId}`, {
					method: 'DELETE'
				});

				if (response.ok) {
					window.location.href = '/collection';
				} else {
					alert('Error al eliminar');
				}
			} catch (error) {
				console.error('Error:', error);
				alert('Error al eliminar');
			}
		}
	});
</script>
